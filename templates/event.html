{% extends "base.html" %}

{% block styles %}
{{ super() }}
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/index.css') }}">
<script>
  if ("{{message}}".startsWith("Error")) {
    alert("{{message}}")
  }

  yenRate = {
    {% for (toC, rate) in currencies['YEN'].items() %}
    {{toC}}:{{rate}},
    {%endfor%}
  }

  function rateOnChange(event) {
    toC = event.value
    rate = yenRate[toC]
    for (let strong of document.getElementsByName("switchableCurrency")) {
      strong.innerHTML = (parseFloat(strong.attributes['value'].value) * rate).toFixed(2);
    }
  }

  function table_search(input) {
    table = document.getElementById("last_100_records_table");
    filter = input.value.toLowerCase();
    tr = table.getElementsByTagName("tr");
    input_id = input.id.split("_")[0]

    // Loop through all table rows, and hide those who don't match the search query
    for (i = 0; i < tr.length; i++) {
      td = tr[i].getElementsByClassName("searchable_" + input_id)[0];
      if (td) {
        txtValue = td.textContent || td.innerText;

        if (txtValue.toLowerCase().includes(filter)) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
  }
</script>
{% endblock %}


{% block content %}
{{ super() }}
<h2 color="red">{{message}}</h2>
<br />
<h3>Add new entry: </h3>
<form method="post" enctype = "multipart/form-data">
   <!-- reporter -->
   <table class="table-condensed">
    <tr>
      <td>
        <label for="reportor">Who paid</label>
      </td>
      <td>
        <select name="reportor">
          {%for p in people%}
            <option value="{{p}}">{{p}}</option>
          {%endfor%}
        </select>
      </td>
    </tr>
    <!-- date -->
    <tr>
      <td>
        <label for="date">Date</label>
      </td>
      <td>
        <input required type="date" name="date" value="{{today}}"/>
      </td>
    </tr>
    <!-- item -->
    <tr>
      <td>
        <label for="item">Description</label>
      </td>
      <td>
        <input required type="text" name="item"/>
      </td>
    </tr>
    <!-- currency -->
    <tr>
      <td>
        <label for="currency">Currency</label>
      </td>
      <td>
        <select name="currency">
          {% for (c, rate) in currencies.items() %}
          <option value="{{c}}">{{c}}</option>
          {%endfor%}
        </select>
      </td>
    </tr>
    <!-- amount -->
    <tr>
      <td>
        <label for="amount">Amount</label>
      </td>
      <td>
        <input required type="number" step="0.01" name="amount"/>
      </td>
    </tr>
    <!-- target -->
    <tr>
      <td>
        <label for="target">Who should pay back</label>
      </td>
      <td>
        <select name="target">
          <option value="shared">Shared</option>
          {%for p in people + share_option%}
            <option value="{{p}}">{{p}}</option>
          {%endfor%}
        </select>
      </td>
    </tr>
    <!-- File -->
    <tr>
      <td>
        <label for="attachment">Image (optional)</label>
      </td>
      <td>
        <input type="file" name="attachment"/>
      </td>
    </tr>
   </table>
  <!-- submit -->
  <input name="action" type="hidden" value="ADD">
  <button type="submit">Add</button>
</form>

<br/>

<h3>TOTAL PAYABLE: </h3>
<!-- currency -->
<label for="currency">Currency</label>
<select id="display_currency_switch" name="currency" onchange="rateOnChange(this)">
  {% for (c, rate) in currencies.items() %}
  <option value="{{c}}">{{c}}</option>
  {%endfor%}
</select>
<br/>
{% for (payer, payee, amount) in payCondensed %}
  {{ payer }} pay {{ payee }}: <strong name="switchableCurrency" value="{{amount}}">{{ amount }}</strong> <br/>
{%endfor%}
<br/>
<table class="table table-hover">  
  <tr>
    <th>Payer \ Receiver</th>
    {%for p in people%}
      <th>{{p}}</th>
    {%endfor%}
  </tr>
  {%for k in payTable%}
    <tr>
      <td>{{ k }}</td>
      {%for p in people%}
        <th>
          <strong name="switchableCurrency" value="{{payTable[k][p]}}">{{ payTable[k][p] }}</strong>
        </th>
      {%endfor%}
    </tr>
  {%endfor%}
</table>
<br />

<h3>Last 100 Records:</h3>
<table id="last_100_records_table" class="table table-striped">
  <tr>
  {%for k, h in headers.items()%}
      <th>
        {{ h }}
        <input type="text" id="{{h}}_search_input" 
                onkeyup="table_search(this)" 
                placeholder="Search {{h}}" />
      </th>
  {%endfor%}
  </tr>

  {%for record in lastRecords%}
    <tr>
      {%for k, v in record.to_dict().items()%}
        <td class="searchable_{{headers[k]}}">
        {%if k == "attachment" %}
          <img style="max-width:300px" src="{{ url_for('static', filename='attachments/' + showingEvent + '/' + v) }}" class="image" />
        {% else %}
          {{ v }}
        {%endif%}
        </td>
      {%endfor%}
      <td>
        <form method="post">
          <input name="action" type="hidden" value="DEL">
          <input value="{{record.name}}" type="hidden" name="hash">
          <button type="submit">DEL</button>
        </form>
      </td>
    </tr>
  {%endfor%}
</table>

<script>
  rateOnChange(document.getElementById("display_currency_switch"))
</script>
{% endblock %}
{{ footer }}